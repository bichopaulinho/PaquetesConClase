---
title: "Paquetes con C++lase"
subtitle: "Crash Course de Interfaces de C++ en R"
author: "<b>Gonzalo Mateo - <a href=\"https://twitter.com/gonzmg88\">@gonzmg88</a></b><br><b>Paulino Tardáguila - <a href=\"https://twitter.com/bicho_paulinho\">@bicho_paulinho</a></b>"
company: "Meteologica"
date: "Reunion Usuarios R Madrid - 10 de diciembre de 2015"
output: 
  ioslides_presentation:
    css: images/pres.css
    widescreen: yes
---

## Paquetes con Clase

![cristina](https://media.giphy.com/media/z0KFEWjSd6UTK/giphy.gif)

### R y C++?

- Generalmente C++ como "acelerador" de funciones de R: recodificación en un lenguaje más veloz
- Lo realmente potente: Extensión de R e **integración de código externo**


## En el mundo real
<div class="centered">
 <img src="images/esquema_meteo.png" height="500px" width="700px" align="middle"/>
</div>
## Interfaz al instante

### Ingredientes:

- Librería con objetos de C++ que queremos integrar
- Función en R que use los objetos anteriores como queremos.
- R, Rcpp y RStudio. <font size="3">(thx Hadley, thx Dirk)</font>
- (un poquito de C++ *programming skills*)

https://github.com/bichopaulinho/PaquetesConClase


## Nuestro caso: Regresión Múltiple usando Gradient Descent {.smaller}

- Integraremos el algoritmo de optimización **Gradient Descent** (implementación sencilla: librería [Purple](http://www.cimne.com/purple/), ligeramente adaptada a nuestro problema)
- Aplicación al problema de regresion lineal multiple
- Resultado: función contenida en un paquete (**GradDesc**)

![purple](http://www.cimne.com/purple/img/CasCabeza.jpg)
 

```{bash, echo=FALSE}
tree GradDesc -L 1
```

## Estructura del directorio src/

```{bash}
tree GradDesc/src -P *.cpp
```


## Funcion objetivo. Esquema

### RcppGradientDescent.cpp (Rcpp)

```{c++,eval=FALSE,}
Rcpp::NumericVector GradientDescentSumaCuadrados(SEXP A,SEXP b) {
    ### <b>
    Purple::Vector<double> M_b = Rcpp::as<Purple::Vector<double>>(b);
    Purple::Matrix<double> M_A = Rcpp::as<Purple::Matrix<double>>(A);
    ### </b>
    //....
    return(Rcpp::wrap<Purple::Vector<double>>(minimalArgument));
}
```
- Argumentos de entrada: `SEXP A,SEXP b`. Objetos de R (Matriz y vector)
- Se transforman en objetos de la clase **Purple**: `Purple::Vector` y `Purple::Matrix`: Especializacion de la plantilla de `Rcpp::as`. Se define en **purple_wrappers.cpp**

## Funcion objetivo. Esquema (II)

### GradientDescent.cpp (Rcpp)

```{c++2,eval=FALSE,}
Rcpp::NumericVector GradientDescentSumaCuadrados(SEXP A,SEXP b) {

    Purple::Vector<double> M_b = Rcpp::as<Purple::Vector<double>>(b);
    Purple::Matrix<double> M_A = Rcpp::as<Purple::Matrix<double>>(A);
    
    //....
    ### <b>
    return(Rcpp::wrap<Purple::Vector<double>>(minimalArgument));
    ### </b>
}
```

- Creación objeto función objetivo, algoritmo de optimización, parámetros, ejecución, etc. 
- Salida: parámetros optimizados (objeto R) mediante especialización a medida de `Rcpp::wrap`. Se define en **purple_wrappers.cpp**



## Compilación {.smaller}

### Fuentes de Purple incluidos en src/
- Ventaja: el paquete es "autocontenido". Es la forma habitual de distribución.
- Incluir todos los cabeceros de la clase en un directorio "include" (dentro del directorio del paquete)
- Las clases de la librería se compilan al instalar el paquete.
- Compilación del paquete con Build tools (devtools, RStudio). Utiliza fichero Makevars (Makevars.win):

```{bash, eval=FALSE}
## -*- mode: makefile; -*-

### <b>
PKG_CXXFLAGS=-I../inst/include
### </b>
## With R 3.1.0 or later, you can uncomment the following line to tell R to
## enable compilation with C++11 (where available)
CXX_STD = CXX11

```
Cómo funciona Rcpp:

`RcppGradientDescent.cpp` ([[Rcpp::export]]) -> `src/RcppExports.cpp` -> `R/RcppExports.R` (Función en R) 

```{r eval=FALSE}
build(".", binary=T, args="--no-multiarch")
```



## La hora de la verdad

Estimación de coeficientes de regresión por Gradient Descent vs OLS

```{r}
library(GradDesc)
head(iris)
```
```{r}
A <- as.matrix(iris[,2:4])
y <- iris[,1]
```
## La hora de la verdad

Estimación de coeficientes de regresión por Gradient Descent vs OLS

```{r}
coefs <- GradientDescentSumaCuadrados(A,y)
names(coefs) <- colnames(A)
# Usando función lm (quitamos el término independiente)
lm(data=iris[,-5], formula=Sepal.Length~.-1)$coefficients
coefs
```
## La hora de la verdad

Estimación de coeficientes de regresión por Gradient Descent vs OLS

```{r}
# Con término independiente: incluimos una columna de unos en la matriz del modelo
A <- cbind(Interc=rep(1,nrow(A)), A)
coefs <- GradientDescentSumaCuadrados(A,y)
names(coefs) <- colnames(A)
lm(data=iris[,-5], formula=Sepal.Length~.)$coefficients
coefs
```


## Extra: Exportación de Clases con RCPP_MODULE {.smaller}
 
- Macro RCPP_MODULE: permite exportar objetos directamente. Similar a `// [[Rcpp::export]]`
- Muy útil para exportar clases completas (constructores, métodos, etc)
- En **src/ModuloSumaCuadrados.cpp** definimos la clase *GradientDescentSumaCuadradosClase* y la exportamos como módulo:
```{c++3, eval=FALSE}
RCPP_MODULE(ModuloSumaCuadrados){
    using namespace Rcpp;

    class_<GradientDescentSumaCuadradosClase>( "GradientDescentSumaCuadradosClase" )

    .constructor<SEXP,SEXP>()

    .method( "solve", &GradientDescentSumaCuadradosClase::getMinimalArgument )
    .method( "setGradientNormGoal", &GradientDescentSumaCuadradosClase::setGradientNormGoal )
    .method( "setEvaluationGoal", &GradientDescentSumaCuadradosClase::setEvaluationGoal )
    .method( "starting_point", &GradientDescentSumaCuadradosClase::setInitialArgument )
    ;
}
```
- Se carga al crear el paquete en **R/GradDesc.R**:
`loadModule("ModuloSumaCuadrados",TRUE)`

## Extra: Otra alternativa de Compilación {.smaller}

### Purple como librería externa
- Ventaja: obtenemos la librería externa de su ubicación original (integración continua)
- Se enlaza al compilar el paquete referenciandola en en el Makevars (`PKG_LIBS`)
```{bash, eval=FALSE}
## -*- mode: makefile; -*-
### <b>
PKG_CXXFLAGS=-I../../Purple
PKG_LIBS=-L../../lib -lPurple
### </b>
## With R 3.1.0 or later, you can uncomment the following line to tell R to
## enable compilation with C++11 (where available)
CXX_STD = CXX11
```
- Previamente hay que compilar Purple. Es **necesario?** Recomendable para evitar problemas de compatibilidad con la tool-chain que compila los paquetes en R (sobre todo en Windows)
- Con ayuda del fichero Makefile (Makefile.win): `make -f Makefile`
- Disponible en `VersionCompilacionExterna/`





